<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Part 4 - Multitemporal River Width</title>
<meta name="identifier" content="g2594b6a31edf2728a3f26765cc716448"/>
<meta name="editing_roles" content="teachers"/>
<meta name="workflow_state" content="active"/>
</head>
<body>
<p><span>Up to this point, we walked through extracting the river centerline and width from a given water mask. In that section, we intentionally unpacked the different steps used to extract river centerline and width so that readers can: (1) get an intuitive idea of how the image processes work step by step and see the resulting images at each stage; (2) combine these functions to answer different questions (e.g., readers might only be interested in river centerlines instead of getting to widths). In this section, we will walk you through how to use some high-level functions in RivWidthCloud to more efficiently implement these steps across multiple water mask images to extract a time series of widths at a given location. To do this, we must provide two inputs: a point of interest (longitude, latitude) and a collection of binary water masks. The code below re-introduces a helper function to convert between projections and then access other data and functionality.</span></p>
<table>
<tbody>
<tr>
<td>
<pre><strong>var</strong><span> getUTMProj = </span><strong>function</strong><span>(lon, lat) {</span><span><br></span><span>&nbsp; &nbsp; </span><span>// Given longitude and latitude in decimal degrees, </span><span><br></span><span>&nbsp; &nbsp; </span><span>// return EPSG string for the corresponding UTM projection. See:</span><span><br></span><span>&nbsp; &nbsp; </span><span>// https://apollomapping.com/blog/gtm-finding-a-utm-zone-number-easily</span><span><br></span><span>&nbsp; &nbsp; </span><span>// https://sis.apache.org/faq.html</span><span><br></span><span>&nbsp; &nbsp; </span><strong>var</strong><span> utmCode = </span><span>ee</span><span>.</span><span>Number</span><span>(lon).</span><span>add</span><span>(</span><span>180</span><span>).</span><span>divide</span><span>(</span><span>6</span><span>).</span><span>ceil</span><span>().</span><span>int</span><span>();</span><span><br></span><span>&nbsp; &nbsp; </span><strong>var</strong><span> output = </span><span>ee</span><span>.</span><span>Algorithms.If</span><span>({</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; condition: </span><span>ee</span><span>.</span><span>Number</span><span>(lat).</span><span>gte</span><span>(</span><span>0</span><span>),</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; trueCase: </span><span>ee</span><span>.</span><span>String</span><span>(</span><span>'EPSG:326'</span><span>).</span><span>cat</span><span>(utmCode</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .</span><span>format</span><span>(</span><span>'%02d'</span><span>)),</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; falseCase: </span><span>ee</span><span>.</span><span>String</span><span>(</span><span>'EPSG:327'</span><span>).</span><span>cat</span><span>(utmCode</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .</span><span>format</span><span>(</span><span>'%02d'</span><span>))</span><span><br></span><span>&nbsp; &nbsp; });</span><span><br></span><span>&nbsp; &nbsp; </span><strong>return</strong><span> (output);</span><span><br></span><span>};</span><span><br></span><span><br></span><span>// IMPORT AND VISUALIZE SURFACE WATER MASK</span><span><br></span><span>// Surface water occurrence dataset from the JRC (Pekel et al., 2016).</span><span><br></span><strong>var</strong><span> jrcYearly = </span><span>ee</span><span>.</span><span>ImageCollection</span><span>(</span><span>'JRC/GSW1_3/YearlyHistory'</span><span>);</span><span><br></span><strong>var</strong><span> poi = </span><span>ee</span><span>.</span><span>Geometry.LineString</span><span>([</span><span><br></span><span>&nbsp; &nbsp; [</span><span>110.77450764660864</span><span>, </span><span>30.954167027937988</span><span>],</span><span><br></span><span>&nbsp; &nbsp; [</span><span>110.77158940320044</span><span>, </span><span>30.950633845897112</span><span>]</span><span><br></span><span>]);</span><span><br></span><span><br></span><strong>var</strong><span> rwcFunction = </span><span>require</span><span>(</span><span><br></span><span>&nbsp; &nbsp; </span><span>'users/eeProject/RivWidthCloudPaper:rwc_watermask.js'</span><span>);</span></pre>
</td>
</tr>
</tbody>
</table>
<p><span>&nbsp;</span></p>
<p><span>Remember that the widths from Sect. 1.2 are stored in a </span><span>FeatureCollection</span><span> with multiple width values from different locations along a centerline. To extract the multitemporal river width for a particular location along a river, we only need one width measurement from each water mask. Here, we choose the width for the centerline pixel that is nearest to the given point of interest using the function</span><span> </span><span>getNearestCl</span><span>. This function takes the width </span><span>FeatureCollection</span><span> from Sect. 1.2 as input and returns a feature corresponding to the width closest to the point of interest.</span></p>
<table>
<tbody>
<tr>
<td>
<pre><span>// Function to identify the nearest river width to a given location.</span><span><br></span><strong>var</strong><span> GetNearestClGen = </span><strong>function</strong><span>(poi) {</span><span><br></span><span>&nbsp; &nbsp; </span><strong>var</strong><span> temp = </span><strong>function</strong><span>(widths) {</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; widths = widths.</span><span>map</span><span>(</span><strong>function</strong><span>(f) {</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><strong>return</strong><span> f.</span><span>set</span><span>(</span><span>'dist2cl'</span><span>, f.</span><span>distance</span><span>(poi,</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span>30</span><span>));</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; });</span><span><br></span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; </span><strong>return</strong><span> </span><span>ee</span><span>.</span><span>Feature</span><span>(widths.</span><span>sort</span><span>(</span><span>'dist2cl'</span><span>, </span><strong>true</strong><span>)</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; .</span><span>first</span><span>());</span><span><br></span><span>&nbsp; &nbsp; };</span><span><br></span><span>&nbsp; &nbsp; </span><strong>return</strong><span> temp;</span><span><br></span><span>};</span><span><br></span><strong>var</strong><span> getNearestCl = GetNearestClGen(poi);</span></pre>
</td>
</tr>
</tbody>
</table>
<p><span>Then, we will need to use the</span><span> </span><span>map</span><span> </span><span>method on the input collection of water masks to apply the</span><span> </span><span>rwc</span><span> </span><span>to all the water mask images. This will result in a </span><span>FeatureCollection</span><span>, each feature containing the width quantified from one image (or time stamp).</span><span>&nbsp;</span></p>
<table>
<tbody>
<tr>
<td>
<pre><span>// Multitemporal width extraction.</span><span><br></span><strong>var</strong><span> polygon = poi.</span><span>buffer</span><span>(</span><span>2000</span><span>);</span><span><br></span><strong>var</strong><span> coords = poi.</span><span>centroid</span><span>().</span><span>coordinates</span><span>();</span><span><br></span><strong>var</strong><span> lon = coords.</span><span>get</span><span>(</span><span>0</span><span>);</span><span><br></span><strong>var</strong><span> lat = coords.</span><span>get</span><span>(</span><span>1</span><span>);</span><span><br></span><strong>var</strong><span> crs = getUTMProj(lon, lat);</span><span><br></span><strong>var</strong><span> scale = </span><span>ee</span><span>.</span><span>Number</span><span>(</span><span>30</span><span>);</span><span><br></span><span><br></span><strong>var</strong><span> multiwidths = </span><span>ee</span><span>.</span><span>FeatureCollection</span><span>(jrcYearly.</span><span>map</span><span>(</span><strong>function</strong><span>(i) {</span><span><br></span><span>&nbsp; &nbsp; </span><strong>var</strong><span> watermask = i.</span><span>gte</span><span>(</span><span>2</span><span>).</span><span>unmask</span><span>(</span><span>0</span><span>);</span><span><br></span><span><br></span><span>&nbsp; &nbsp; watermask = </span><span>ee</span><span>.</span><span>Image</span><span>(watermask.</span><span>rename</span><span>([</span><span>'waterMask'</span><span>])</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; .</span><span>setMulti</span><span>({</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; crs: crs,</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; scale: scale,</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; image_id: i.</span><span>getNumber</span><span>(</span><span>'year'</span><span>)</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; }));</span><span><br></span><span>&nbsp; &nbsp; </span><strong>var</strong><span> rwc = rwcFunction.rwGen_waterMask(</span><span>2000</span><span>, </span><span>333</span><span>, </span><span>300</span><span>,</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; polygon);</span><span><br></span><span>&nbsp; &nbsp; </span><strong>var</strong><span> widths = rwc(watermask)</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; .</span><span>filter</span><span>(</span><span>ee</span><span>.</span><span>Filter.eq</span><span>(</span><span>'endsInWater'</span><span>, </span><span>0</span><span>))</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; .</span><span>filter</span><span>(</span><span>ee</span><span>.</span><span>Filter.eq</span><span>(</span><span>'endsOverEdge'</span><span>, </span><span>0</span><span>));</span><span><br></span><span><br></span><span>&nbsp; &nbsp; </span><strong>return</strong><span> </span><span>ee</span><span>.</span><span>Algorithms.If</span><span>(widths.</span><span>size</span><span>(), getNearestCl(</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; widths), </span><strong>null</strong><span>);</span><span><br></span><span>}, </span><strong>true</strong><span>));</span><span><br></span><span><br></span><strong>var</strong><span> widthTs = </span><span>ui</span><span>.</span><span>Chart.feature.byFeature</span><span>(multiwidths, </span><span>'image_id'</span><span>, [</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; </span><span>'width'</span><span><br></span><span>&nbsp; &nbsp; ])</span><span><br></span><span>&nbsp; &nbsp; .</span><span>setOptions</span><span>({</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; hAxis: {</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; title: </span><span>'Year'</span><span>,</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; format: </span><span>'####'</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; },</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; vAxis: {</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; title: </span><span>'Width (meter)'</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; },</span><span><br></span><span>&nbsp; &nbsp; &nbsp; &nbsp; title: </span><span>'River width time series upstream of the Three Gorges Dam'</span><span><br></span><span>&nbsp; &nbsp; });</span><span><br></span><span>print</span><span>(widthTs);</span><span><br></span><span><br></span><span>Map</span><span>.</span><span>centerObject</span><span>(polygon);</span><span><br></span><span>Map</span><span>.</span><span>addLayer</span><span>(polygon, {}, 'area of width calculation');</span></pre>
</td>
</tr>
</tbody>
</table>
<p><img src="$IMS-CC-FILEBASE$/Uploaded%20Media/Screenshot%202023-10-26%20at%2011.13.00%E2%80%AFAM.png" alt="Figure - River width time series upstream of the Three Gorges Dam in China. The series shows the abrupt increase in river width around the year 2003, when the dam was completed." loading="lazy"></p>
<p><em><span>Figure - River width time series upstream of the Three Gorges Dam in China. The series shows the abrupt increase in river width around the year 2003, when the dam was completed.</span></em></p>
<p>&nbsp;</p>
</body>
</html>